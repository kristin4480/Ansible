---
- hosts: localhost
  name: loop
  gather_facts: false
  become: false
  tasks:
    - name: returning vm list on a folder
      vmware_vm_info:
        validate_certs: no
        hostname: "{{esxi_host.server}}"
        password: Lucario44!
        username: root
        folder: "ha-datacenter/"
      register: vms

    - name: Dinamically add VM to hosts file
      become: false
      add_host:
        groups:
          - web-servers
        hostname: "{{item.guest_name}}"
        ansible_host: "{{item.ip_address}}"
        ansible_user: "kris"
        ansible_ssh_private_key_file: "~/.ssh/id_rsa_kris"
        ansible_ssh_pass: VMware1!
      with_items: "{{vms.virtual_machines}}"

    - name: accept new ssh fingerprints
      shell: ssh-keyscan -H {{ item.ip_address }} >> ~/.ssh/known_hosts
      with_items: "{{ vms.virtual_machines }}"
    